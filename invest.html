<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invest</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Poppins',sans-serif;background:#f8fafc;margin:0;padding-bottom:100px;color:#111;}
    .wrap{max-width:900px;margin:auto;padding:18px;}
    h1{text-align:center;color:#0f172a;margin:10px 0 20px;}

    .card{background:#fff;border-radius:14px;padding:20px;margin-bottom:20px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
    .wallet-balance{font-size:18px;font-weight:600;margin-bottom:12px;color:#2563eb;}
    .input-box{margin-top:12px;}
    input[type=number]{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;text-align:center;font-size:15px;}
    .btn{padding:12px 18px;border:none;border-radius:10px;font-weight:700;color:#fff;cursor:pointer;font-size:14px;}
    .btn-primary{background:linear-gradient(135deg,#22c55e,#16a34a);}
    .btn-cancel{background:linear-gradient(135deg,#ef4444,#dc2626);}
    .row{display:flex;gap:12px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
    .btn{flex:1;max-width:180px;text-align:center;}

    .overview p{margin:6px 0;font-size:15px;}
    .overview span{font-weight:700;color:#111;}

    .history{margin-top:30px;}
    .history h2{text-align:center;margin-bottom:15px;}
    .history-item{background:#fff;padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .status-active{color:#2563eb;font-weight:700;}
    .status-complete{color:#22c55e;font-weight:700;}
    .status-cancel{color:#ef4444;font-weight:700;}

    /* Popup */
    .popup{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);display:none;
      align-items:center;justify-content:center;z-index:2000;
    }
    .popup-box{
      background:#fff;padding:20px;border-radius:14px;
      box-shadow:0 8px 30px rgba(0,0,0,0.2);text-align:center;max-width:300px;width:90%;
    }
    .popup-buttons{margin-top:15px;display:flex;gap:10px;justify-content:center;}

    nav {
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      display:flex;
      background:#fff;
      border-top:1px solid #e5e7eb;
      box-shadow:0 -2px 6px rgba(0,0,0,0.1);
      z-index:1000;
      height:55px;
    }
    nav a {
      flex:1;
      text-decoration:none;
      color:#333;
      font-weight:500;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      font-size:12px;
      position:relative;
    }
    nav a span {
      width:16px;
      height:16px;
      display:inline-block;
    }
    nav a:hover,
    nav a.active {
      color:#4f46e5;
    }
    nav a.active::before {
      content:"";
      position:absolute;
      bottom:0;
      left:30%;
      width:40%;
      height:2px;
      background:#4f46e5;
      border-radius:2px;
    }
    .home { border:2px solid #06b6d4; transform:rotate(45deg); }
    .invest { border:2px solid #2563eb; border-radius:4px; }
    .promotion { border:2px solid #16a34a; border-radius:50%; }
    .account { border:2px solid #f59e0b; border-radius:50% 50% 50% 0; }
    nav a:not(:last-child)::after {
      content:"";
      position:absolute;
      right:0;
      top:20%;
      bottom:20%;
      width:1px;
      background:#e0e0e0;
    }
    .countdown {
  font-size: 14px;
  color: #dc2626;
  font-weight: 600;
  margin-top: 4px;
}

  </style>
</head>
<body>
  <div class="wrap">
    

    <!-- Wallet + Form -->
    <div class="card">
      <div class="wallet-balance">Wallet Balance: <span id="walletBalance">$0.00</span></div>
      <div class="input-box">
        <input type="number" id="stakeAmount" placeholder="Enter amount (min $200)">
      </div>
      <div class="row">
        <button class="btn btn-primary" onclick="createStake()">Stake Now</button>
        <button class="btn btn-cancel" onclick="cancelStake()">Cancel</button>
      </div>
    </div>

    <!-- Overview -->
    <div class="card overview">
      <p>Active Investment: <span id="activeInvest">$0.00</span></p>
      <p>Your Daily Profit (0.7%): <span id="dailyProfit">$0.00</span></p>
      <p>Upline Distribution (from 0.3% daily):</p>
      <ul>
        <li>Level 1 Upline: 0.17%</li>
        <li>Level 2 Upline: 0.08%</li>
        <li>Level 3 Upline: 0.05%</li>
      </ul>
    </div>

    <!-- History -->
    <div class="history">
      <h2>Investment History</h2>
      <div id="historyList"><p style="text-align:center;color:#666;">Loading...</p></div>
    </div>
  </div>

  <!-- Navbar -->
  <nav>
    <a href="index.html" class="home-link"><span class="home"></span>Home</a>
    <a href="invest.html" class="invest-link active"><span class="invest"></span>Invest</a>
    <a href="promotion.html" class="promotion-link"><span class="promotion"></span>Promotion</a>
    <a href="account.html" class="account-link"><span class="account"></span>Account</a>
  </nav>

  <!-- Popup -->
  <div id="popup" class="popup">
    <div class="popup-box">
      <p id="popupMessage">Message</p>
      <div class="popup-buttons">
        <button onclick="closePopup()" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, addDoc, collection, query, orderBy, where, getDocs, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
      authDomain: "btcinvest-c0e25.firebaseapp.com",
      projectId: "btcinvest-c0e25",
      storageBucket: "btcinvest-c0e25.firebasestorage.app",
      messagingSenderId: "204937458487",
      appId: "1:204937458487:web:cc27ece1249999279f60b2",
      measurementId: "G-HG0Q8ZHT6G"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const walletBalanceEl=document.getElementById("walletBalance");
    const activeInvestEl=document.getElementById("activeInvest");
    const dailyProfitEl=document.getElementById("dailyProfit");
    const historyList=document.getElementById("historyList");
    const stakeAmountEl=document.getElementById("stakeAmount");

    let currentUserId=null;
    function fmt(n){return "$"+Number(n||0).toFixed(2);}

    // Popup
    window.showPopup=function(msg){
      document.getElementById("popupMessage").textContent=msg;
      document.getElementById("popup").style.display="flex";
    }
    window.closePopup=function(){
      document.getElementById("popup").style.display="none";
    }

    onAuthStateChanged(auth,(user)=>{
      if(!user){window.location.href="auth.html";return;}
      currentUserId=user.uid;
      listenWallet();
      listenInvestments();
      setInterval(()=>processMatured(currentUserId),60000); // check every 1 min
    });

    function listenWallet(){
      onSnapshot(doc(db,"users",currentUserId),snap=>{
        if(snap.exists()) walletBalanceEl.textContent=fmt(snap.data().walletBalance||0);
      });
    }

    function listenInvestments(){
      const invCol=collection(db,"users",currentUserId,"investments");
      const q=query(invCol,orderBy("startTime","desc"));
      onSnapshot(q,snap=>{
        historyList.innerHTML="";
        if(snap.empty){
          historyList.innerHTML="<p style='text-align:center;color:#666;'>No investments yet.</p>";
          return;
        }
        let total=0,profit=0;
        snap.forEach(docSnap=>{
          const d=docSnap.data();
          if(d.status==="Active"){total+=d.amount;profit+=d.amount*0.01*0.7;}
          const when=d.startTime?new Date(d.startTime.seconds*1000).toLocaleString():"-";
          const cls=d.status==="Completed"?"status-complete":d.status==="Active"?"status-active":"status-cancel";
           // Agar Active hai to countdown show karega
  let countdownHtml = "";
  if(d.status==="Active" && d.startTime){
    const endTime = d.startTime.seconds*1000 + 24*60*60*1000;
    countdownHtml = `<div class="countdown" id="cd_${id}">Loading...</div>`;
    // ✅ Countdown start karo
    setTimeout(()=>startCountdown("cd_"+id,endTime),500);
  }


          historyList.innerHTML+=`
            <div class="history-item">
              <div><div><b>${fmt(d.amount)}</b></div><div style="font-size:13px;color:#555;">${when}</div></div>
              <div class="${cls}">${d.status}</div>
            </div>`;
        });
        activeInvestEl.textContent=fmt(total);
        dailyProfitEl.textContent=fmt(profit);
      });
    }

    // ✅ Create stake
    window.createStake=async function(){
      const amount=parseFloat(stakeAmountEl.value)||0;
      if(amount<200){showPopup("Minimum invest $200");return;}
      const balText=walletBalanceEl.textContent.replace("$","");
      const currentBalance=parseFloat(balText)||0;
      if(currentBalance<amount){showPopup("Insufficient balance!");return;}

      const userRef=doc(db,"users",currentUserId);
      try{
        await runTransaction(db,async(tx)=>{
          const uSnap=await tx.get(userRef);
          if(!uSnap.exists()) throw "User missing";
          const bal=uSnap.data().walletBalance||0;
          if(bal<amount) throw "Insufficient balance";
          tx.update(userRef,{walletBalance:bal-amount});
          await addDoc(collection(db,"users",currentUserId,"investments"),{
            amount,startTime:serverTimestamp(),status:"Active",
            dailyRate:0.01,userPercent:0.7,upline1:0.17,upline2:0.08,upline3:0.05
          });
        });
        stakeAmountEl.value="";
        showPopup("Investment added successfully!");
      }catch(err){showPopup(typeof err==="string"?err:"Error creating investment");}
    }

    // ✅ Cancel stake
    window.cancelStake=async function(){
      const invCol=collection(db,"users",currentUserId,"investments");
      const q=query(invCol,where("status","==","Active"),orderBy("startTime","desc"));
      const res=await getDocs(q);
      if(res.empty){showPopup("No active investment to cancel");return;}
      const inv=res.docs[0],data=inv.data();
      const invRef=doc(db,"users",currentUserId,"investments",inv.id);
      const userRef=doc(db,"users",currentUserId);
      try{
        await runTransaction(db,async(tx)=>{
          tx.update(invRef,{status:"Canceled"});
          const uSnap=await tx.get(userRef);
          tx.update(userRef,{walletBalance:(uSnap.data().walletBalance||0)+data.amount});
        });
        showPopup("Investment canceled and refunded (No profit).");
      }catch(err){showPopup("Error canceling investment");}
    }

    // ✅ Auto close after 24h
    async function processMatured(uid){
      const invCol=collection(db,"users",uid,"investments");
      const q=query(invCol,where("status","==","Active"));
      const snap=await getDocs(q);
      if(snap.empty) return;
      const now=Date.now();
      for(const docSnap of snap.docs){
        const d=docSnap.data();
        if(!d.startTime) continue;
        const start=d.startTime.seconds*1000;
        if(now>=start+24*60*60*1000){
          const invRef=doc(db,"users",uid,"investments",docSnap.id);
          const userRef=doc(db,"users",uid);
          await runTransaction(db,async(tx)=>{
            const inv=await tx.get(invRef);
            if(!inv.exists()||inv.data().status!=="Active") return;
            const amt=inv.data().amount;
            const profitUser=amt*0.01*0.7;
            const payout=amt+profitUser;
            const u1=amt*0.01*0.17,u2=amt*0.01*0.08,u3=amt*0.01*0.05;

            const userSnap=await tx.get(userRef);
            const uData=userSnap.data();
            tx.update(userRef,{walletBalance:(uData.walletBalance||0)+payout});

            if(uData.ref1){const r=doc(db,"users",uData.ref1);const s=await tx.get(r);if(s.exists())tx.update(r,{walletBalance:(s.data().walletBalance||0)+u1});}
            if(uData.ref2){const r=doc(db,"users",uData.ref2);const s=await tx.get(r);if(s.exists())tx.update(r,{walletBalance:(s.data().walletBalance||0)+u2});}
            if(uData.ref3){const r=doc(db,"users",uData.ref3);const s=await tx.get(r);if(s.exists())tx.update(r,{walletBalance:(s.data().walletBalance||0)+u3});}

            tx.update(invRef,{status:"Completed",completedAt:serverTimestamp()});
          });
        }
      }
    }
    function startCountdown(elId,endTime){
  function update(){
    const el=document.getElementById(elId);
    if(!el) return;
    const now=Date.now();
    const diff=endTime-now;

    if(diff<=0){el.textContent="Matured (Processing...)";return;}
    const h=Math.floor(diff/(1000*60*60));
    const m=Math.floor((diff%(1000*60*60))/(1000*60));
    const s=Math.floor((diff%(1000*60))/1000);
    el.textContent=`${h}h ${m}m ${s}s`;
  }
  update();
  setInterval(update,1000);
}

  </script>
</body>
</html>
