 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
    body {font-family:'Poppins',sans-serif;background:#f5f7fa;margin:0;padding:20px;padding-bottom:100px;color:#333;}
    h1{text-align:center;margin-bottom:20px;color:#222;}
    .dashboard{max-width:800px;margin:auto;background:#fff;border-radius:16px;padding:25px;box-shadow:0 6px 20px rgba(0,0,0,0.1);text-align:center;}
    .info-card{margin-top:20px;background:#fff;border-radius:16px;padding:25px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}
    .btn{padding:12px 20px;font-size:16px;font-weight:bold;border:none;border-radius:10px;cursor:pointer;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,0.15);}
    .btn-withdraw{background:#28a745;}.btn-withdraw:hover{background:#28a745;}
    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:2000;}

    /* âœ… Compact Popup */
    .popup{
      background:#fff;
      border-radius:12px;
      padding:15px;
      width:90%;
      max-width:280px;  /* pehle 350px tha */
      text-align:center;
      box-shadow:0 6px 15px rgba(0,0,0,0.25);
      animation:fadeIn 0.3s ease;
      margin:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    @keyframes fadeIn{from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}

    /* âœ… Smaller Inputs */
    .address-input,.amount-input{
      width:100%;
      padding:8px;          /* pehle 10px tha */
      margin-top:10px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:13px;
      outline:none;
      text-align:center;
    }

    .amount-instruction{font-size:14px;font-weight:bold;color:#007bff;margin-top:10px;display:none;}

    .action-buttons{display:flex;justify-content:space-between;gap:10px;margin-top:12px;width:100%;}

    /* âœ… Smaller Buttons */
    .action-buttons button{
      flex:1;
      padding:8px;          /* pehle 10px tha */
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
      font-size:13px;
      color:#fff;
    }
    .close-btn{background:#dc3545;}
    .submit-btn{background:#28a745;}

    .history-section{margin-top:30px;}
    .history-card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08);font-size:14px;}
    .history-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .badge{background:#28a745;color:#fff;padding:3px 10px;border-radius:6px;font-weight:bold;font-size:13px;}
    .status.pending{color:#ff8800;font-weight:bold;}.status.completed{color:green;font-weight:bold;}.status.canceled{color:red;font-weight:bold;}
    .history-card-row{display:flex;justify-content:space-between;margin:6px 0;}
    .history-card-row span.label{font-weight:600;color:#444;}
    .history-card-row span.value{font-weight:bold;color:#007bff;}
    .thankyou-popup,.error-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:15px 25px;border-radius:12px;font-weight:bold;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:3000;display:none;animation:fadeInOut 1.5s ease forwards;}
    .thankyou-popup{background:#28a745;color:#fff;}.error-popup{background:#dc3545;color:#fff;}
    @keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}20%{opacity:1;transform:translate(-50%,-50%) scale(1);}80%{opacity:1;}100%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}}
    .refresh-btn{background:#17a2b8;color:#fff;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin:10px auto;display:block;}
    .refresh-btn:hover{background:#138496;}

    /* ðŸŒŠ Wave Bottom Navbar */
    .wave-nav {position: fixed;bottom: 0;left: 0;width: 100%;height: 70px;background: linear-gradient(135deg, #007bff, #00c6ff);clip-path: polygon(0 20%, 15% 0, 85% 0, 100% 20%, 100% 100%, 0 100%);display: flex;justify-content: space-around;align-items: center;z-index: 1000;box-shadow: 0 -4px 15px rgba(0,0,0,0.2);}
    .wave-nav a {flex: 1;text-align: center;font-size: 13px;color: #fff;text-decoration: none;font-weight: 600;display: flex;flex-direction: column;align-items: center;justify-content: center;transition: 0.3s;}
    .wave-nav a:hover { opacity: 0.85; }
    .wave-nav a.active { color: #ffeb3b; }
    .wave-nav i {font-size: 22px;margin-bottom: 4px;}
</style>

</head>
<body>

  <div class="dashboard">
    <div class="info-card">
      <h2 style="color:#28a745;"> Balance: $<span id="availableBalance">0</span></h2>
      <p>Click below to <b>Withdraw Funds</b> securely.</p>
      <button class="btn btn-withdraw" onclick="openPopup()">Request Withdrawal</button>
    </div>

    <div class="history-section">
  <h2 style="color:#007bff; text-align:center;"> Withdrawal History</h2>
  <button class="refresh-btn" onclick="manualRefresh()">ðŸ”„ Refresh History</button>
  <div id="historyList"><p style="text-align:center; color:#666;">Loading...</p></div>
</div>


  <!-- âœ… Popup -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <h2>Withdraw Funds</h2>
      <input type="number" id="withdrawAmount" class="amount-input" placeholder="Enter amount to withdraw">
      <input type="text" id="withdrawAddress" class="address-input" placeholder="Enter your BEP20 address">
      <div id="amountInstruction" class="amount-instruction"></div>
      <div class="action-buttons">
        <button class="close-btn" onclick="cancelWithdraw()">Cancel</button>
        <button class="submit-btn" onclick="submitWithdraw()">Submit</button>
      </div>
    </div>
  </div>

  <div class="thankyou-popup" id="thankyouPopup">Withdrawal Requested</div>
  <div class="error-popup" id="errorPopup">Enter valid details</div>

 <!-- ðŸŒŠ Wave Bottom Navigation -->
  <div class="wave-nav">
    <a href="dashboard.html" class="active">
      <i data-lucide="home"></i>
      <span>Home</span>
    </a>
    <a href="investment.html">
      <i data-lucide="trending-up"></i>
      <span>Invest</span>
    </a>
    <a href="account.html">
      <i data-lucide="user"></i>
      <span>Account</span>
    </a>
  </div>

  <!-- âœ… Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script> lucide.createIcons(); </script>

  <!-- âœ… Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
      authDomain: "btcinvest-c0e25.firebaseapp.com",
      projectId: "btcinvest-c0e25",
      storageBucket: "btcinvest-c0e25.firebasestorage.app",
      messagingSenderId: "204937458487",
      appId: "1:204937458487:web:cc27ece1249999279f60b2",
      measurementId: "G-HG0Q8ZHT6G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const popupOverlay = document.getElementById("popupOverlay");
    const thankyouPopup = document.getElementById("thankyouPopup");
    const errorPopup = document.getElementById("errorPopup");
    const historyList = document.getElementById("historyList");
    const balanceEl = document.getElementById("availableBalance");
    const addressInput = document.getElementById("withdrawAddress");

    let currentUserId = null;
    let userBalance = 0;
    let userWalletAddress = "";

    function showError(msg) {
      errorPopup.textContent = msg;
      errorPopup.style.display = "block";
      setTimeout(() => { errorPopup.style.display = "none"; }, 1500);
    }

    function showSuccess(msg) {
      thankyouPopup.textContent = msg;
      thankyouPopup.style.display = "block";
      setTimeout(() => { thankyouPopup.style.display = "none"; }, 2000);
    }

    function generateOrderId() {
      const randomNum = Math.floor(1000000000 + Math.random() * 9000000000);
      return "WDBHGR" + randomNum + "G";
    }

    async function loadUserProfile(uid) {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        userBalance = data.balance || 0;
        userWalletAddress = data.walletAddress || "";
        balanceEl.textContent = userBalance.toFixed(2);
        if (userWalletAddress) addressInput.value = userWalletAddress;
      }
    }

    window.openPopup = function() {
      popupOverlay.style.display = "flex";
      document.getElementById("withdrawAmount").value = "";
      addressInput.value = userWalletAddress || "";
    };

    window.cancelWithdraw = function() {
      popupOverlay.style.display = "none";
    };

    window.submitWithdraw = async function() {
      const amount = parseFloat(document.getElementById("withdrawAmount").value) || 0;
      const address = addressInput.value.trim();

      if (amount < 20) { showError("Minimum withdrawal is $20"); return; }
      if (amount > userBalance) { showError("Insufficient balance"); return; }
      if (!address || address.length < 20) { showError("Enter valid address"); return; }

      const orderId = generateOrderId();

      if (currentUserId) {
        await addDoc(collection(db, "users", currentUserId, "withdrawals"), {
          amount: amount,
          address: address,
          date: serverTimestamp(),
          status: "Pending",
          orderId: orderId
        });

        // Balance minus
        const ref = doc(db, "users", currentUserId);
        await updateDoc(ref, { balance: userBalance - amount });

        loadWithdrawHistory(currentUserId);
        loadUserProfile(currentUserId);
      }

      popupOverlay.style.display = "none";
      showSuccess("Withdrawal Requested!");
    };

    window.manualRefresh = function() {
      if (currentUserId) loadWithdrawHistory(currentUserId);
    };

    async function loadWithdrawHistory(userId) {
      historyList.innerHTML = "<p style='text-align:center; color:#666;'>Loading...</p>";
      try {
        const q = query(collection(db, "users", userId, "withdrawals"), orderBy("date", "desc"));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
          historyList.innerHTML = "<p style='text-align:center; color:#666;'>No withdrawals yet.</p>";
          return;
        }
        historyList.innerHTML = "";
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const dateStr = data.date ? new Date(data.date.seconds*1000).toLocaleString() : "-";
          const statusClass = (data.status || "Pending").toLowerCase();
          historyList.innerHTML += `
            <div class="history-card">
              <div class="history-card-header">
                <span class="badge">Withdraw</span>
                <span class="status ${statusClass}">${data.status || "Pending"}</span>
              </div>
              <div class="history-card-row"><span class="label">Amount</span><span class="value">$${data.amount || 0}</span></div>
              <div class="history-card-row"><span class="label">Address</span><small>${data.address || "-"}</small></div>
              <div class="history-card-row"><span class="label">Time</span><small>${dateStr}</small></div>
              <div class="history-card-row"><span class="label">ID</span>
                <span><small>${data.orderId || docSnap.id}</small>
                <button onclick="copyOrderId('${data.orderId || docSnap.id}')">Copy</button></span>
              </div>
            </div>`;
        });
      } catch (err) {
        console.error("Error:", err);
        historyList.innerHTML = "<p style='text-align:center; color:red;'>Error loading history</p>";
      }
    }

    window.copyOrderId = function(orderId) {
      navigator.clipboard.writeText(orderId);
      showError("Order ID copied!");
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "auth.html";
      else { 
        currentUserId = user.uid; 
        loadUserProfile(user.uid);
        loadWithdrawHistory(user.uid); 
      }
    });

    // âœ… Navbar Highlight
    document.querySelectorAll(".wave-nav a").forEach(link => {
      if (link.href === window.location.href) link.classList.add("active");
      else link.classList.remove("active");
    });
  </script>
</body>
</html>

