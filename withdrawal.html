<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {font-family:'Poppins',sans-serif;background:#f5f7fa;margin:0;padding-bottom:100px;color:#333;}
    h1{text-align:center;margin-bottom:20px;color:#222;}
    .dashboard{max-width:800px;margin:auto;background:#fff;border-radius:16px;padding:25px;box-shadow:0 6px 20px rgba(0,0,0,0.1);text-align:center;}
    .info-card{margin-top:20px;background:#fff;border-radius:16px;padding:25px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}
    .btn{padding:12px 20px;font-size:16px;font-weight:bold;border:none;border-radius:10px;cursor:pointer;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,0.15);}
    .btn-withdraw{background:#28a745;}.btn-withdraw:hover{background:#218838;}
    .popup-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:2000;}

    /* âœ… Popup */
    .popup{
      background:#fff;
      border-radius:12px;
      padding:20px;
      width:90%;
      max-width:320px;
      text-align:center;
      box-shadow:0 6px 15px rgba(0,0,0,0.25);
      animation:fadeIn 0.3s ease;
      margin:auto;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    @keyframes fadeIn{from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);}}

    .popup label{font-size:13px;font-weight:600;color:#333;align-self:flex-start;margin-top:6px;}

    .amount-input,.address-input{
      width:100%;
      padding:8px;
      margin-top:6px;
      border:1px solid #ccc;
      border-radius:6px;
      font-size:13px;
      outline:none;
      text-align:center;
    }

    .amount-instruction{font-size:14px;font-weight:bold;color:#007bff;margin-top:10px;display:none;}

    .action-buttons{display:flex;justify-content:space-between;gap:10px;margin-top:14px;width:100%;}
    .action-buttons button{flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;font-size:13px;color:#fff;}
    .close-btn{background:#dc3545;}
    .submit-btn{background:#28a745;}

    .history-section{margin-top:30px;}
    .history-card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,0,0,0.08);font-size:14px;}
    .history-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
    .badge{background:#28a745;color:#fff;padding:3px 10px;border-radius:6px;font-weight:bold;font-size:13px;}
    .status.pending{color:#ff8800;font-weight:bold;}.status.completed{color:green;font-weight:bold;}.status.canceled{color:red;font-weight:bold;}
    .history-card-row{display:flex;justify-content:space-between;margin:6px 0;}
    .history-card-row span.label{font-weight:600;color:#444;}
    .history-card-row span.value{font-weight:bold;color:#007bff;}

    .copy-btn{background:#007bff;color:#fff;border:none;border-radius:4px;padding:3px 6px;font-size:12px;margin-left:6px;cursor:pointer;transition:0.3s;}
    .copy-btn:hover{background:#0056b3;}

    .thankyou-popup,.error-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:15px 25px;border-radius:12px;font-weight:bold;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:3000;display:none;animation:fadeInOut 1.5s ease forwards;}
    .thankyou-popup{background:#28a745;color:#fff;}.error-popup{background:#dc3545;color:#fff;}
    @keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}20%{opacity:1;transform:translate(-50%,-50%) scale(1);}80%{opacity:1;}100%{opacity:0;transform:translate(-50%,-50%) scale(0.9);}}

    .refresh-btn{background:#17a2b8;color:#fff;padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin:10px auto;display:block;}
    .refresh-btn:hover{background:#138496;}

    /* âœ… Bottom Nav */
    nav {position:fixed;bottom:0;left:0;width:100%;display:flex;background:#fff;border-top:1px solid #e5e7eb;box-shadow:0 -2px 6px rgba(0,0,0,0.1);z-index:1000;height:55px;}
    nav a {flex:1;text-decoration:none;color:#333;font-weight:500;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:12px;position:relative;}
    nav a span {width:16px;height:16px;display:inline-block;}
    nav a:hover,nav a.active {color:#4f46e5;}
    nav a.active::before {content:"";position:absolute;bottom:0;left:30%;width:40%;height:2px;background:#4f46e5;border-radius:2px;}
    .home {border:2px solid #06b6d4;transform:rotate(45deg);}
    .invest {border:2px solid #2563eb;border-radius:4px;}
    .promotion {border:2px solid #16a34a;border-radius:50%;}
    .account {border:2px solid #f59e0b;border-radius:50% 50% 50% 0;}
    nav a:not(:last-child)::after {content:"";position:absolute;right:0;top:20%;bottom:20%;width:1px;background:#e0e0e0;}
    
    .history-card-row small {
  display: inline-block;
  max-width: 200px;   /* jitna chhota card ke andar fit ho */
  word-break: break-all;  /* address ko tod ke next line me bhej dega */
  overflow-wrap: break-word;
  white-space: normal;
}

  </style>
</head>
<body>

  <div class="dashboard">
    <div class="info-card">
      <h2 style="color:#28a745;"> Balance: $<span id="availableBalance">0</span></h2>
      <p>Click below to <b>Withdraw Funds</b> securely.</p>
      <button class="btn btn-withdraw" onclick="openPopup()">Request Withdrawal</button>
    </div>

    <!-- âœ… History -->
    <div class="history-section">
      <h2 style="color:#007bff; text-align:center;"> Withdrawal History</h2>
      <button class="refresh-btn" onclick="manualRefresh()">ðŸ”„ Refresh History</button>
      <div id="historyList"><p style="text-align:center; color:#666;">Loading...</p></div>
    </div>
  </div>

  <!-- âœ… Popup -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <h2 style="margin-bottom:8px;color:#222;">Withdraw Funds</h2>
      <p style="font-size:13px;color:#666;margin-bottom:10px;">
        Minimum withdrawal: <b style="color:#28a745;">$20</b><br>
        Available balance: <b id="popupBalance" style="color:#007bff;">0</b>
      </p>

      <label>Amount ($)</label>
      <input type="number" id="withdrawAmount" class="amount-input" placeholder="Enter withdrawal amount">

      <label>Type</label>
      <input type="text" value="USDT (BEP20)" disabled class="address-input">

      <label>Your Wallet Address</label>
      <input type="text" id="withdrawAddress" class="address-input" placeholder="Enter your BEP20 address">

      <div class="action-buttons">
        <button class="close-btn" onclick="cancelWithdraw()">Cancel</button>
        <button class="submit-btn" onclick="submitWithdraw()">Submit</button>
      </div>
    </div>
  </div>

  <div class="thankyou-popup" id="thankyouPopup">Withdrawal Requested</div>
  <div class="error-popup" id="errorPopup">Enter valid details</div>

  <!-- âœ… Bottom Navigation -->
  <nav>
    <a href="index.html" class="home-link active"><span class="home"></span>Home</a>
    <a href="invest.html" class="invest-link"><span class="invest"></span>Invest</a>
    <a href="promotion.html" class="promotion-link"><span class="promotion"></span>Promotion</a>
    <a href="account.html" class="account-link"><span class="account"></span>Account</a>
  </nav>

  <script>
    // Highlight active nav
    const links = document.querySelectorAll("nav a");
    links.forEach(link => {
      link.addEventListener("click", function() {
        links.forEach(l => l.classList.remove("active"));
        this.classList.add("active");
      });
    });
  </script>

  <!-- âœ… Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
      authDomain: "btcinvest-c0e25.firebaseapp.com",
      projectId: "btcinvest-c0e25",
      storageBucket: "btcinvest-c0e25.firebasestorage.app",
      messagingSenderId: "204937458487",
      appId: "1:204937458487:web:cc27ece1249999279f60b2",
      measurementId: "G-HG0Q8ZHT6G"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const popupOverlay = document.getElementById("popupOverlay");
    const thankyouPopup = document.getElementById("thankyouPopup");
    const errorPopup = document.getElementById("errorPopup");
    const historyList = document.getElementById("historyList");
    const balanceEl = document.getElementById("availableBalance");
    const popupBalance = document.getElementById("popupBalance");
    const addressInput = document.getElementById("withdrawAddress");

    let currentUserId = null;
    let userBalance = 0;
    let userWalletAddress = "";

    function showError(msg) {
      errorPopup.textContent = msg;
      errorPopup.style.display = "block";
      setTimeout(() => { errorPopup.style.display = "none"; }, 1500);
    }

    function showSuccess(msg) {
      thankyouPopup.textContent = msg;
      thankyouPopup.style.display = "block";
      setTimeout(() => { thankyouPopup.style.display = "none"; }, 2000);
    }

    function generateOrderId() {
      const randomNum = Math.floor(1000000000 + Math.random() * 9000000000);
      return "WDBHGR" + randomNum + "G";
    }

    async function loadUserProfile(uid) {
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        userBalance = data.balance || 0;
        userWalletAddress = data.walletAddress || "";
        balanceEl.textContent = userBalance.toFixed(2);
        popupBalance.textContent = userBalance.toFixed(2);
        if (userWalletAddress) addressInput.value = userWalletAddress;
      }
    }

    window.openPopup = function() {
      popupOverlay.style.display = "flex";
      document.getElementById("withdrawAmount").value = "";
      addressInput.value = userWalletAddress || "";
    };

    window.cancelWithdraw = function() {
      popupOverlay.style.display = "none";
    };

    window.submitWithdraw = async function() {
      const amount = parseFloat(document.getElementById("withdrawAmount").value) || 0;
      const address = addressInput.value.trim();

      if (amount < 20) { showError("Minimum withdrawal is $20"); return; }
      if (amount > userBalance) { showError("Insufficient balance"); return; }
      if (!address || address.length < 20) { showError("Enter valid address"); return; }

      const orderId = generateOrderId();

      if (currentUserId) {
        await addDoc(collection(db, "users", currentUserId, "withdrawals"), {
          amount: amount,
          type: "USDT (BEP20)",
          address: address,
          date: serverTimestamp(),
          status: "Pending",
          orderId: orderId
        });

        // Balance minus
        const ref = doc(db, "users", currentUserId);
        await updateDoc(ref, { balance: userBalance - amount });

        loadWithdrawHistory(currentUserId);
        loadUserProfile(currentUserId);
      }

      popupOverlay.style.display = "none";
      showSuccess("Withdrawal Requested!");
    };

    window.manualRefresh = function() {
      if (currentUserId) loadWithdrawHistory(currentUserId);
    };

    async function loadWithdrawHistory(userId) {
      historyList.innerHTML = "<p style='text-align:center; color:#666;'>Loading...</p>";
      try {
        const q = query(collection(db, "users", userId, "withdrawals"), orderBy("date", "desc"));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
          historyList.innerHTML = "<p style='text-align:center; color:#666;'>No withdrawals yet.</p>";
          return;
        }
        historyList.innerHTML = "";
        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const dateStr = data.date ? new Date(data.date.seconds*1000).toLocaleString() : "-";
          const statusClass = (data.status || "Pending").toLowerCase();
          historyList.innerHTML += `
            <div class="history-card">
              <div class="history-card-header">
                <span class="badge">Withdraw</span>
                <span class="status ${statusClass}">${data.status || "Pending"}</span>
              </div>
              <div class="history-card-row"><span class="label">Amount</span><span class="value">$${data.amount || 0}</span></div>
              <div class="history-card-row"><span class="label">Type</span><small>${data.type || "USDT (BEP20)"}</small></div>
              <div class="history-card-row"><span class="label">Address</span><small>${data.address || "-"}</small>
                 </div>

              <div class="history-card-row"><span class="label">Time</span><small>${dateStr}</small></div>
              <div class="history-card-row"><span class="label">ID</span>
                <span><small>${data.orderId || docSnap.id}</small>
                <button class="copy-btn" onclick="copyOrderId('${data.orderId || docSnap.id}')">Copy</button></span>
              </div>
            </div>`;
        });
      } catch (err) {
        console.error("Error:", err);
        historyList.innerHTML = "<p style='text-align:center; color:red;'>Error loading history</p>";
      }
    }

    window.copyOrderId = function(orderId) {
      navigator.clipboard.writeText(orderId);
      showError("Order ID copied!");
    };

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "auth.html";
      else { 
        currentUserId = user.uid; 
        loadUserProfile(user.uid);
        loadWithdrawHistory(user.uid); 
      }
    });
  </script>
</body>
</html>
