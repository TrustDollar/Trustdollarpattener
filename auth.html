<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Register/Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    margin:0;
  }

  /* Header fixed top */
  .header {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    text-align: center;
    padding: 12px;
    font-size: 18px;
    font-weight: bold;
    background: linear-gradient(90deg,#4CAF50,#2c7);
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    z-index: 1000;
  }

  /* Wrapper: center fixed */
  .wrapper {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-height: calc(100vh - 70px);
    overflow-y: auto;
    padding: 10px;
    box-sizing: border-box;
  }

  .login-top-note {
    font-size:14px;
    color:#333;
    background:#eef5ff;
    padding:8px 12px;
    border:1px solid #cce0ff;
    border-radius:6px;
    text-align:center;
    width:380px;
    max-width:95%;
    margin-bottom:12px;
    display:none;
  }

  .container {
    background: #fff;
    padding: 20px 30px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    width: 380px;
    max-width: 95%;
    text-align:center;
  }

  h2 {
    text-align: center;
    margin:0 0 12px 0;
    font-size:22px;
    font-weight:bold;
  }

  input {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size:14px;
  }

  .password-container { position: relative; }
  .password-container i {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    user-select:none;
    font-size:16px;
  }

  button {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border: none;
    border-radius: 5px;
    background: #4CAF50;
    color: white;
    font-size: 16px;
    cursor: pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    font-weight:bold;
    transition: background 0.3s;
  }
  button:hover { background:#3a9440; }
  button:disabled { opacity: 0.6; cursor: not-allowed; }

  .toggle {
    text-align: center;
    margin-top: 14px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #f9f9f9;
    cursor: pointer;
    color: #0066ff;
    font-size: 14px;
    transition: all 0.3s ease;
  }
  .toggle:hover { background: #e6f0ff; border-color: #0066ff; }

  .login-note {
    margin-top: 12px;
    font-size: 13px;
    color: #b22;
    text-align: center;
    background: #fff3f3;
    padding: 8px;
    border: 1px solid #f5c2c2;
    border-radius: 5px;
    width:380px;
    max-width:95%;
    display:none;
  }

  .popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    display: none;
    z-index: 2000;
    font-size: 15px;
  }
  .popup.success { border-left: 5px solid green; }
  .popup.error { border-left: 5px solid red; }

  .loader {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #fff;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
    display:none;
  }
  @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
</style>
</head>
<body>
  <div class="header">Suggested by TrustDollar</div>

  <div class="wrapper">
    <!-- Login Top Note -->
    <div class="login-top-note" id="login-top-note">
      üëã Welcome back! Please login to continue.
    </div>

    <!-- Register/Login Card -->
    <div class="container" id="form-container">
      <h2 id="form-title">Register</h2>

      <input type="text" id="name" placeholder="Name">
      <input type="text" id="register-email" placeholder="Email">
      <input type="text" id="username" placeholder="Username">
      <input type="text" id="mobile" placeholder="Mobile Number">
      <input type="text" id="aadhaar" placeholder="Aadhaar">
      <input type="text" id="cheque" placeholder="Upline cheque ( fund security)">

      <input type="text" id="login-identifier" placeholder="Email / Mobile / Username" style="display:none;">

      <div class="password-container" id="password-container">
        <input type="password" id="password" placeholder="Password">
        <i id="toggle-password">üëÅÔ∏è</i>
      </div>

      <div class="password-container" id="confirm-pass-container">
        <input type="password" id="confirm-password" placeholder="Confirm Password">
        <i id="toggle-confirm-password">üëÅÔ∏è</i>
      </div>

      <input type="text" id="referral" placeholder="Referral Code (Optional)">

      <button id="submit-btn">
        <span id="btn-text">Register</span>
        <div class="loader" id="loader"></div>
      </button>

      <div class="toggle" id="toggle-form">Already have an account? Login</div>
    </div>

    <!-- Login Bottom Note -->
    <div class="login-note" id="login-note">
      ‚ö†Ô∏è For your security, do not share your password.  
      If you forgot your password, <a href="#">click here</a>.
    </div>
  </div>

  <div id="popup" class="popup"></div>




<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.firebasestorage.app",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2",
  measurementId: "G-HG0Q8ZHT6G"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const popup = document.getElementById('popup');
const loader = document.getElementById('loader');
const submitBtn = document.getElementById('submit-btn');
const btnText = document.getElementById('btn-text');

function showPopup(msg, type='success'){
  popup.textContent = msg;
  popup.className = `popup ${type}`;
  popup.style.display = 'block';
  setTimeout(()=>{ popup.style.display='none'; },1500);
}

function disableForm(val){
  submitBtn.disabled = val;
  loader.style.display = val ? 'inline-block':'none';
  document.querySelectorAll('input').forEach(i=>i.disabled = val);
}

let isRegister = true;
const formTitle = document.getElementById('form-title');
const toggleForm = document.getElementById('toggle-form');
const nameInput = document.getElementById('name');
const regEmailInput = document.getElementById('register-email');
const usernameInput = document.getElementById('username');
const mobileInput = document.getElementById('mobile');
const aadhaarInput = document.getElementById('aadhaar');
const chequeInput = document.getElementById('cheque');
const loginIdentifier = document.getElementById('login-identifier');
const passwordInput = document.getElementById('password');
const confirmPasswordInput = document.getElementById('confirm-password');
const confirmPassContainer = document.getElementById('confirm-pass-container');
const passwordContainer = document.getElementById('password-container');
const referralInput = document.getElementById('referral');
const formContainer = document.getElementById('form-container');

const togglePassword = document.getElementById('toggle-password');
const toggleConfirmPassword = document.getElementById('toggle-confirm-password');
togglePassword.addEventListener('click', ()=> {
  passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
});
toggleConfirmPassword.addEventListener('click', ()=> {
  confirmPasswordInput.type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
});

function validateEmail(email){
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function showAllFields(showRegister){
  isRegister = showRegister;
  formTitle.textContent = isRegister ? 'Register' : 'Login';
  btnText.textContent = isRegister ? 'Register' : 'Login';
  toggleForm.textContent = isRegister ? 'Already have an account? Login' : "Don't have an account? Register";

  nameInput.style.display = isRegister ? 'block':'none';
  regEmailInput.style.display = isRegister ? 'block':'none';
  usernameInput.style.display = isRegister ? 'block':'none';
  mobileInput.style.display = isRegister ? 'block':'none';
  aadhaarInput.style.display = isRegister ? 'block':'none';
  chequeInput.style.display = isRegister ? 'block':'none';
  referralInput.style.display = isRegister ? 'block':'none';
  confirmPassContainer.style.display = isRegister ? 'block':'none';
  loginIdentifier.style.display = isRegister ? 'none':'block';

  document.getElementById('login-top-note').style.display = isRegister ? 'none':'block';
  document.getElementById('login-note').style.display = isRegister ? 'none':'block';

  if(!isRegister){
    formContainer.insertBefore(loginIdentifier, passwordContainer);
  } else {
    formContainer.insertBefore(loginIdentifier, referralInput);
  }
}

showAllFields(true);
toggleForm.addEventListener('click', ()=> { showAllFields(!isRegister); });

submitBtn.addEventListener('click', async ()=>{
  disableForm(true);
  const name = nameInput.value.trim();
  const regEmail = regEmailInput.value.trim();
  const username = usernameInput.value.trim();
  const mobile = mobileInput.value.trim();
  const aadhaar = aadhaarInput.value.trim();
  const cheque = chequeInput.value.trim();
  const identifier = loginIdentifier.value.trim();
  const password = passwordInput.value.trim();
  const confirmPassword = confirmPasswordInput.value.trim();
  const referral = referralInput.value.trim();

  try {
    if(isRegister){
      if(!name || !regEmail || !username || !mobile || !aadhaar || !password || !confirmPassword){
        showPopup("Please fill all required fields","error"); disableForm(false); return;
      }
      if(!validateEmail(regEmail)){ showPopup("Invalid Email Format","error"); disableForm(false); return; }
      if(password !== confirmPassword){ showPopup("Passwords do not match","error"); disableForm(false); return; }
      if(password.length < 6){ showPopup("Password must be at least 6 characters","error"); disableForm(false); return; }
      if(!/^\d{10}$/.test(mobile)){ showPopup("Mobile must be 10 digits","error"); disableForm(false); return; }
      if(!/^[a-zA-Z0-9]{3,}$/.test(username)){ showPopup("Username: min 3 chars, letters and numbers only","error"); disableForm(false); return; }
      if(!/^\d{12}$/.test(aadhaar)){ showPopup("Aadhaar must be 12 digits","error"); disableForm(false); return; }
      if(cheque !== "" && !/^\d{6,20}$/.test(cheque)){ showPopup("Cheque No. must be 6-20 digits","error"); disableForm(false); return; }

      const usersRef = collection(db, "users");
      const checks = [
        { field: "email", value: regEmail, msg: "Email already registered" },
        { field: "mobile", value: mobile, msg: "Mobile already registered" },
        { field: "username", value: username, msg: "Username already taken" },
        { field: "name", value: name, msg: "Name already registered" }
      ];
      for(const c of checks){
        const q = query(usersRef, where(c.field, "==", c.value));
        const snap = await getDocs(q);
        if(!snap.empty){ showPopup(c.msg,"error"); disableForm(false); return; }
      }

      const userCredential = await createUserWithEmailAndPassword(auth, regEmail, password);
      const user = userCredential.user;
      const finalReferral = referral !== "" ? referral : ("REF" + Math.floor(Math.random()*900000 + 100000));

      await setDoc(doc(db, "users", user.uid), {
        name,
        email: regEmail,
        username,
        mobile,
        aadhaar,
        chequeNumber: cheque !== "" ? cheque : null,
        referralCode: finalReferral,
        createdAt: new Date().toISOString()
      });

      showPopup("Registration Successful!","success");
      setTimeout(()=>{ window.location.href = "index.html"; },800);

    } else {
      if(!identifier || !password){ showPopup("Enter Email/Mobile/Username and Password","error"); disableForm(false); return; }

      const usersRef = collection(db, "users");
      let q, type="";
      if(identifier.includes("@")){ q=query(usersRef, where("email", "==", identifier)); type="email"; }
      else if(/^\d{10}$/.test(identifier)){ q=query(usersRef, where("mobile", "==", identifier)); type="mobile"; }
      else{ q=query(usersRef, where("username", "==", identifier)); type="username"; }

      const snap = await getDocs(q);
      if(snap.empty){ showPopup("No user found with that "+type,"error"); disableForm(false); return; }

      const userDoc = snap.docs[0];
      const userEmail = userDoc.data().email;
      try { await signInWithEmailAndPassword(auth, userEmail, password); }
      catch(e){ showPopup("Wrong password","error"); disableForm(false); return; }

      showPopup("Login Successful! Welcome "+(userDoc.data().name || ""), "success");
      setTimeout(()=>{ window.location.href = "index.html"; },800);
    }
  } catch(err){
    console.error(err);
    showPopup(err.message || "Error occurred","error");
    disableForm(false);
  }
});
</script>
</script>
</body>
</html>
